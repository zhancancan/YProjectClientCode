local user 			= require "Data_Character"
local dbase 		= require "DataManager" .dbase

local manager 		= require "CharacterUseSkill"

local this={}
local med
local class 		= require "Class"
local item 			= class("ControlMediator_SkillItem")
local GameTicker 	= require "GameTicker"
local TableEvent 	= require "EventType".TableEvent
local DataClasses 	= require "DataClasses"

function item.createItem()
	return item.new()
end

function item.pickPrefab(pane,data,index)
	return index == 0 and 0 or 1
end

function item:draw(cell,data)
	-- cell:SetString("txt",data.name)
	cell:SetClickTrigger("icon")
	print(string.format("skill cell ,%s",data))
	cell:SetString("icon",data.icon)
end

function item:onInit(cell,data)
	self.data = data
	self.cell = cell
	-- GameTicker.normalTicker:add(self)
end

function item:updateNow(now)
	local firetime = self.data.firetime
	local dif = now - firetime
	local cd = self.data.cooldown
	self.cell:SetFloat("img_2",dif/cd)
end

function item:onRemove()
	-- GameTicker.normalTicker:remove(self)
end

function item:onClick(_,data)
	manager.tryCast(data)
end

local function resetPane()
	local h = user.hero
	if h then
		med:SetList("pane",h:getSkills())
	else
		med:SetList("pane",nil)
	end
end

local function onTableUpdate()
	resetPane()
end
local function onHeroUpdate(p)
	if p == "heroId" then
		resetPane()
	end
end

function this:show()
	dbase:getTable(DataClasses.DATA_SKILLOBJ):addListener(TableEvent.UPDATE,self, onTableUpdate)
	dbase:getTable(DataClasses.DATA_USERHERO):addListener(TableEvent.UPDATE,self, onTableUpdate)
	user:addListener(self,onHeroUpdate)
	resetPane()
end

function this:hide()
	med:SetList("pane",nil)
	dbase:getTable(DataClasses.DATA_SKILLOBJ):removeListener(TableEvent.UPDATE,self, onTableUpdate)
	dbase:getTable(DataClasses.DATA_USERHERO):removeListener(TableEvent.UPDATE,self, onTableUpdate)
	user:removeListener(self,onHeroUpdate)
end

function this:initView(mediator)
	med = mediator
	med:SetPaneFactory("pane",item)
end

return this;
